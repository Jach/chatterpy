<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Chatterpy Chat</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<!-- color picker -->
<script type="text/javascript" src="{{ base_url }}/static/farbtastic.js"></script>
<link rel="stylesheet" href="{{ base_url }}/static/farbtastic.css" type="text/css"></script>

<link rel="stylesheet" href="{{ base_url }}/static/style.css" type="text/css" />
<script type="text/javascript">
var username = '{{ name }}'

var render_ui = function() {
  $('#loginsubmit').click(login_chat)
  $('#sendformsubmit').height($('#messagetextholder').height())
  $('#sendformsubmit').click(post_message)
  $('#colorpickerholder').hide()
  $('#colorpicker').farbtastic('#fontcolor')
  $('#togglepicker').click(function(ev) {
      $('#colorpickerholder').toggle(500)
      $('html, body').animate({scrollTop: $('#togglepicker').offset().top }, 510)
  })
}

$(function () {
  render_ui()
  $.post('{{ base_url }}/check/name/', {username: username},
    function(r) {
      if (r.success) {
        $('#username').html(username)
        $.post('{{ base_url }}/name/', {username: username})
        start_chat()
      } else {
        login_prompt()
      }
    }, 'json')
  }
)

var login_prompt = function() {
  $('#loginerror').hide()
  $('#loginboxbackground').css({'opacity': '0.5'})
  $('#loginboxbackground').fadeIn('slow')
  $('#loginbox').fadeIn('slow')
  // center:
  var win_w = document.documentElement.clientWidth
  var win_h = document.documentElement.clientHeight
  var log_h = $('#loginbox').height()
  var log_w = $('#loginbox').width()
  $('#loginbox').css({'position': 'absolute',
      'top': win_h / 2 - log_h / 2,
      'left': win_w / 2 - log_w / 2
  })
  $('loginboxbackground').css({'height': win_h})
}

var login_chat = function(ev) {
  ev.preventDefault()
  $('#loginerror').hide()
  $.post('{{ base_url }}/name/', {
      username: $('#loginusername').val()},
    function(r) {
      if (r.success) {
        username = $('#loginusername').val()
        $('#username').html(username)
        $('#loginboxbackground').fadeOut('slow')
        $('#loginbox').fadeOut('slow')
        start_chat()
      } else {
        $('#loginerror').show()
      }
    }, 'json')
}

var start_chat = function() {
  /* get last N messages */
  check_messages(true)

  window.setInterval(function(){check_messages(false)}, {{ update_interval }})
}

var post_message = function(ev) {
  ev.preventDefault()
  $.post('{{ base_url }}/post/', {
      color: $('#fontcolor').val(),
      message: $('#messagetext').val()},
    function(r) {
      if (r.success) {
        $('#messagetext').val('')
        check_messages(true)
      } else {
        alert('Message not sent!')
      }
    }, 'json')
}

var last_message_id = 0
var ignore_id = -1 /* not used */
var check_messages = function(force_scroll) {
  $.get('{{ base_url }}/check/messages/' + last_message_id,
    function(r) {
      var should_scroll = force_scroll ||
        $('#messagebox').attr('scrollHeight') == $('#messagebox').scrollTop()
      $.each(r.messages, add_message)
      if (should_scroll) {
        $('#messagebox').scrollTop($('#messagebox').attr('scrollHeight'))
      }
    }, 'json')
}

var add_message = function(idx, value) {
  var col = value.color
  var msg = value.message
  var spk = value.speaker
  last_message_id = value.id

  var html = '<div style="color: ' + col + '" class="message">' + 
  '<span style="font-weight: bolder; color: black;"> ' + spk + ': </span>' +
  msg + '</div>\n'
  if (value.id != ignore_id) {
    $('#messagebox').append(html)
  }
}

</script>
</head>
<body>
  <noscript><h1>Turn your scripts on, foo.</h1></noscript>

  <div id="appcontainer">

  <div id="usersbox">
  </div>

  <div id="messagebox">
  </div>

  <div id="sendbox">
    <form id="sendform">
      <div id="messagetextholder">
        <div id="username">
        </div>
        <!--<textarea name="messagetext" id="messagetext" rows="3"></textarea>
        -->
        <input type="text" name="messagetext" id="messagetext" />
        <input type="submit" value="Send" id="sendformsubmit" />
      </div>
      <div id="colorpickerholder">
        <div id="colorpicker"></div>
        <input type="text" name="fontcolor" id="fontcolor" value="#000000" />
      </div>
    </form>
    <br />
    <button id="togglepicker">Font Color</button>
  </div>

  </div>
  <div id="loginbox">
    Welcome! Please enter your desired username.
    <br /><br />
    <form id="loginform">
      <input type="text" name="username" id="loginusername" />
      <input type="submit" value="Join Chat" id="loginsubmit" />
      <div class="error" id="loginerror">That username is unavailable.</div>
    </form>
  </div>
  <div id="loginboxbackground"></div>

</body>
</html>
